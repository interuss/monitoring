# Dockerfile for interuss/monitoring
#
# The image generated by this Dockerfile (via ./build.sh) includes the entire
# `monitoring` folder contents in /app/monitoring and has installed dependencies
# necessary to run any of the monitoring tools.  See documentation for any of
# the applicable tools for instructions on how to use the generated image.  A
# search for "interuss/monitoring" within the repository should yield most of
# the places where this image is in use.
#
# This image is intended to be built from the repository root context/folder.

FROM python:3.11-slim
# Not -alpine because: https://stackoverflow.com/a/58028091/651139

RUN apt-get update && apt-get install -y openssl curl libgeos-dev gcc && apt-get install ca-certificates

# required for gevent to build without error in an ARM environment
RUN apt-get update && apt-get install -y libffi-dev libssl-dev python3-dev build-essential

# required for lxml to install successfully with pip (at least on an ARM environment)
RUN apt-get update && apt-get install -y libxml2-dev libxslt-dev

RUN mkdir -p /app/monitoring
COPY ./requirements.txt /app/monitoring/requirements.txt
RUN pip install -r /app/monitoring/requirements.txt

RUN rm -rf __pycache__

ADD ./interfaces /app/interfaces
ADD ./monitoring /app/monitoring
COPY ./monitoring/health_check.sh /app/health_check.sh
RUN chmod 766 /app/health_check.sh
WORKDIR /app/monitoring

# Additional preparations for uss_qualifier/webapp
RUN mkdir -p /app/uss-host-files

HEALTHCHECK CMD sh /app/health_check.sh

ENV PYTHONPATH /app
ARG version
ARG commit_hash
ENV MONITORING_VERSION=$version
ENV GIT_COMMIT_HASH=$commit_hash
ENTRYPOINT []
